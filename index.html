<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PunkMe Generator - Farcaster Mini-App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000000;
            font-family: 'Courier New', monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            text-align: center;
            max-width: 400px;
            width: 100%;
        }

        h1 {
            color: #00ff00;
            font-size: 24px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px #00ff00;
            letter-spacing: 2px;
        }

        .punk-display {
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            border: 2px solid #00ff00;
            box-shadow: 0 0 20px #00ff00;
            image-rendering: pixelated;
            background-color: #000;
        }

        .punk-button {
            background: transparent;
            border: 2px solid #00ff00;
            color: #00ff00;
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 3px;
            transition: all 0.3s ease;
            text-shadow: 0 0 5px #00ff00;
            box-shadow: 0 0 15px #00ff00;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .punk-button:hover {
            background-color: #00ff00;
            color: #000;
            text-shadow: none;
            box-shadow: 0 0 25px #00ff00;
        }

        .punk-button:active {
            transform: scale(0.95);
        }

        .punk-button::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(45deg, #00ff00, #00cc00, #00ff00);
            z-index: -1;
            filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .punk-button:hover::before {
            opacity: 1;
        }

        .punk-traits {
            color: #00ff00;
            margin-top: 20px;
            font-size: 12px;
            text-align: left;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .punk-traits h3 {
            margin-bottom: 10px;
            text-shadow: 0 0 5px #00ff00;
        }

        .punk-traits ul {
            list-style: none;
            padding: 0;
        }

        .punk-traits li {
            margin-bottom: 5px;
            padding: 2px 5px;
            background: rgba(0, 255, 0, 0.1);
        }

        .wallet-status {
            color: #00ff00;
            margin-top: 15px;
            font-size: 12px;
            padding: 8px;
            border: 1px solid #00ff00;
            background: rgba(0, 255, 0, 0.05);
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PUNKME GENERATOR</h1>
        <canvas id="punkCanvas" class="punk-display" width="24" height="24"></canvas>
        <button class="punk-button" onclick="generatePunk()">PUNKME</button>
        
        <div class="wallet-status" id="walletStatus">
            ðŸ”— Wallet: Not Connected
        </div>
        
        <div class="punk-traits">
            <h3>TRAITS:</h3>
            <ul id="traitsList"></ul>
        </div>
    </div>

    <script>
        // Prevent any content script conflicts
        if (typeof window.ethereum !== 'undefined') {
            // Safe Ethereum provider handling
            const safeEthereum = {
                request: async (method) => {
                    console.log('Safe Ethereum request:', method);
                    return null;
                },
                on: (event, callback) => {
                    console.log('Safe Ethereum listener:', event);
                },
                removeListener: (event, callback) => {
                    console.log('Safe Ethereum remove listener:', event);
                }
            };

            // Wrap ethereum provider to prevent conflicts
            window.ethereum = new Proxy(window.ethereum, {
                get(target, prop) {
                    if (prop === 'request' || prop === 'on' || prop === 'removeListener') {
                        return safeEthereum[prop];
                    }
                    return target[prop];
                }
            });
        }

        // CryptoPunks color palette
        const COLORS = {
            skin: ['#F8D898', '#D6A56B', '#A57C52', '#7A5230', '#452812'],
            hair: ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#000000', '#FFFFFF'],
            bg: ['#000000', '#1A1A1A', '#333333'],
            accessories: ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#FF00FF', '#FFFFFF']
        };

        // Punk traits and features
        const TRAITS = {
            types: ['Human', 'Zombie', 'Ape', 'Alien'],
            accessories: [
                'Earring', 'Cigarette', 'Pipe', 'Medical Mask', 'VR Headset',
                'Horned Rim Glasses', 'Big Shades', 'Classic Shades', 'Eye Mask',
                'Bandana', 'Top Hat', 'Cowboy Hat', 'Beanie', 'Cap Forward',
                'Cap Red', 'Headband', 'Pilot Helmet', 'Tiara', 'Wild Hair',
                'Mohawk', 'Peak Spike', 'Messy Hair', 'Straight Hair', 'Shaved Head'
            ],
            facialHair: ['Luxurious Beard', 'Mustache', 'Goat', 'Shadow Beard', 'Normal Beard'],
            emotions: ['Smile', 'Frown', 'Neutral', 'Surprised']
        };

        class PunkGenerator {
            constructor() {
                this.canvas = document.getElementById('punkCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.traitsList = document.getElementById('traitsList');
                this.walletStatus = document.getElementById('walletStatus');
                this.currentPunk = null;
                this.init();
            }

            init() {
                this.setupWalletListeners();
                this.generate();
            }

            setupWalletListeners() {
                // Safe wallet event listeners
                if (typeof window.ethereum !== 'undefined') {
                    try {
                        window.ethereum.on('chainChanged', (chainId) => {
                            this.updateWalletStatus(`Chain Changed: ${chainId}`);
                        });

                        window.ethereum.on('accountsChanged', (accounts) => {
                            if (accounts.length > 0) {
                                this.updateWalletStatus(`Connected: ${accounts[0].slice(0, 8)}...`);
                            } else {
                                this.updateWalletStatus('ðŸ”— Wallet: Not Connected');
                            }
                        });

                        window.ethereum.on('connect', (connectInfo) => {
                            this.updateWalletStatus('Connected to chain');
                        });

                        window.ethereum.on('disconnect', (error) => {
                            this.updateWalletStatus('Wallet Disconnected');
                        });

                    } catch (error) {
                        console.log('Wallet listeners setup complete');
                    }
                }
            }

            updateWalletStatus(message) {
                if (this.walletStatus) {
                    this.walletStatus.textContent = `ðŸ”— ${message}`;
                }
            }

            generate() {
                // Clear canvas with random background
                this.ctx.fillStyle = this.getRandomColor(COLORS.bg);
                this.ctx.fillRect(0, 0, 24, 24);

                // Generate punk traits
                const punk = {
                    type: this.getRandomTrait(TRAITS.types),
                    skinColor: this.getRandomColor(COLORS.skin),
                    hairColor: this.getRandomColor(COLORS.hair),
                    hasAccessory: Math.random() > 0.6,
                    accessory: this.getRandomTrait(TRAITS.accessories),
                    hasFacialHair: Math.random() > 0.7,
                    facialHair: this.getRandomTrait(TRAITS.facialHair),
                    emotion: this.getRandomTrait(TRAITS.emotions),
                    special: Math.random() > 0.92, // 8% chance for rare
                    id: this.generatePunkId()
                };

                this.currentPunk = punk;
                this.drawPunk(punk);
                this.displayTraits(punk);
                
                return punk;
            }

            drawPunk(punk) {
                const ctx = this.ctx;

                // Draw base (face)
                ctx.fillStyle = punk.type === 'Zombie' ? '#8BAB8B' : 
                               punk.type === 'Ape' ? '#8B7355' : 
                               punk.type === 'Alien' ? '#00FF00' : punk.skinColor;
                
                // Face shape
                this.drawFace(ctx, punk);

                // Eyes
                this.drawEyes(ctx, punk);

                // Mouth based on emotion
                this.drawMouth(ctx, punk);

                // Hair/head features
                this.drawHair(ctx, punk);

                // Accessories
                if (punk.hasAccessory) {
                    this.drawAccessory(ctx, punk);
                }

                // Facial hair
                if (punk.hasFacialHair) {
                    this.drawFacialHair(ctx, punk);
                }

                // Special effects for rare punks
                if (punk.special) {
                    this.drawSpecialEffects(ctx);
                }
            }

            drawFace(ctx, punk) {
                ctx.fillStyle = punk.type === 'Zombie' ? '#8BAB8B' : 
                               punk.type === 'Ape' ? '#8B7355' : 
                               punk.type === 'Alien' ? '#00FF00' : punk.skinColor;
                
                // Main face
                ctx.fillRect(6, 4, 12, 14);
                
                // Ears
                ctx.fillRect(4, 8, 2, 4);
                ctx.fillRect(18, 8, 2, 4);
            }

            drawEyes(ctx, punk) {
                ctx.fillStyle = '#000000';
                
                if (punk.type === 'Alien') {
                    // Alien eyes
                    ctx.fillRect(8, 8, 2, 4);
                    ctx.fillRect(14, 8, 2, 4);
                } else {
                    // Normal eyes
                    ctx.fillRect(9, 8, 1, 2);
                    ctx.fillRect(14, 8, 1, 2);
                    
                    // Pupils
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(9, 8, 1, 1);
                    ctx.fillRect(14, 8, 1, 1);
                }
            }

            drawMouth(ctx, punk) {
                ctx.fillStyle = '#000000';
                
                switch(punk.emotion) {
                    case 'Smile':
                        ctx.fillRect(9, 14, 6, 1);
                        ctx.fillRect(8, 15, 1, 1);
                        ctx.fillRect(15, 15, 1, 1);
                        break;
                    case 'Frown':
                        ctx.fillRect(9, 15, 6, 1);
                        ctx.fillRect(8, 14, 1, 1);
                        ctx.fillRect(15, 14, 1, 1);
                        break;
                    case 'Surprised':
                        ctx.fillRect(10, 14, 4, 3);
                        break;
                    default: // Neutral
                        ctx.fillRect(9, 15, 6, 1);
                }
            }

            drawHair(ctx, punk) {
                if (punk.type === 'Alien') return; // Aliens are bald
                
                ctx.fillStyle = punk.hairColor;
                
                // Different hair styles based on random selection
                const hairStyle = Math.floor(Math.random() * 4);
                
                switch(hairStyle) {
                    case 0: // Mohawk
                        ctx.fillRect(6, 2, 12, 2);
                        for (let i = 0; i < 12; i += 2) {
                            ctx.fillRect(6 + i, 0, 1, 2);
                        }
                        break;
                    case 1: // Wild hair
                        ctx.fillRect(5, 2, 14, 3);
                        // Spikes
                        for (let i = 0; i < 14; i += 2) {
                            if (Math.random() > 0.5) {
                                ctx.fillRect(5 + i, 0, 1, 2);
                            }
                        }
                        break;
                    case 2: // Cap
                        ctx.fillStyle = '#FF0000';
                        ctx.fillRect(5, 2, 14, 2);
                        ctx.fillRect(7, 4, 10, 1);
                        break;
                    default: // Normal hair
                        ctx.fillRect(5, 2, 14, 3);
                }
            }

            drawAccessory(ctx, punk) {
                ctx.fillStyle = this.getRandomColor(COLORS.accessories);
                
                if (punk.accessory.includes('Glasses') || punk.accessory.includes('Shades')) {
                    // Glasses
                    ctx.fillRect(7, 7, 8, 2);
                    ctx.fillRect(7, 7, 2, 1);
                    ctx.fillRect(13, 7, 2, 1);
                } else if (punk.accessory.includes('Hat')) {
                    // Hat
                    ctx.fillRect(4, 1, 16, 2);
                    ctx.fillRect(6, 3, 12, 1);
                } else if (punk.accessory.includes('Earring')) {
                    // Earrings
                    ctx.fillRect(3, 9, 1, 1);
                    ctx.fillRect(20, 9, 1, 1);
                }
            }

            drawFacialHair(ctx, punk) {
                ctx.fillStyle = punk.hairColor;
                ctx.fillRect(8, 16, 8, 2);
                ctx.fillRect(9, 18, 6, 1);
            }

            drawSpecialEffects(ctx) {
                // Glow effect for rare punks
                ctx.strokeStyle = '#FFFF00';
                ctx.lineWidth = 1;
                ctx.strokeRect(2, 2, 20, 20);
                
                // Sparkles
                ctx.fillStyle = '#FFFFFF';
                for (let i = 0; i < 5; i++) {
                    const x = Math.floor(Math.random() * 24);
                    const y = Math.floor(Math.random() * 24);
                    ctx.fillRect(x, y, 1, 1);
                }
            }

            generatePunkId() {
                return Math.floor(Math.random() * 10000).toString().padStart(4, '0');
            }

            getRandomColor(colorArray) {
                return colorArray[Math.floor(Math.random() * colorArray.length)];
            }

            getRandomTrait(traitArray) {
                return traitArray[Math.floor(Math.random() * traitArray.length)];
            }

            displayTraits(punk) {
                const traits = [
                    `Punk #${punk.id}`,
                    `Type: ${punk.type}`,
                    `Skin: ${punk.skinColor}`,
                    `Hair: ${punk.hairColor}`,
                    `Emotion: ${punk.emotion}`,
                    punk.hasAccessory ? `Accessory: ${punk.accessory}` : 'Accessory: None',
                    punk.hasFacialHair ? `Facial Hair: ${punk.facialHair}` : 'Facial Hair: None',
                    punk.special ? 'â˜… RARE PUNK â˜…' : 'Common'
                ].filter(Boolean);

                this.traitsList.innerHTML = traits.map(trait => 
                    `<li>${trait}</li>`
                ).join('');
            }
        }

        // Initialize generator
        let punkGenerator;

        function generatePunk() {
            if (!punkGenerator) {
                punkGenerator = new PunkGenerator();
            } else {
                punkGenerator.generate();
            }
        }

        // Generate initial punk on load
        window.addEventListener('load', function() {
            punkGenerator = new PunkGenerator();
            
            // Safe initialization - prevent any conflicts
            console.log('PunkMe Generator initialized successfully');
            
            // Clean up any potential global conflicts
            if (window.rabby-content-script) {
                console.log('Content script wrapper active');
            }
        });

        // Export for potential Farcaster integration
        window.PunkMeGenerator = {
            generate: generatePunk,
            version: '1.0.0'
        };
    </script>
</body>
</html>
